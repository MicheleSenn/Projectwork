---
title: Scare-off measures against wild boars 
subtitle: computational movement analysis
author: Lia Baumann and Michele Senn
output: html_document
---

```{r, echo = FALSE, warning=FALSE, message=FALSE}

#set the setting for all code chunks:

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load wild boar data, include=FALSE}
#load packages
library(devtools)
devtools::install_github("ComputationalMovementAnalysis/ComputationalMovementAnalysisData")
library(ComputationalMovementAnalysisData)
library(ggplot2)
library(dplyr)
library(sf)
```

# Abstract
This project aims to develop a method for modelling the behavior of wild boars who have been in contact with scare-off measures. The hypothesis is that their behavior can be modeled by comparing the average time they spent in a certain field before the scare-off measure called "Schreck" was put into action, during and after. A second approach of calculating the distance of the boar to the Schreck will also be shown in this project.

--> fill in the results

#Introduction
This project aims to develop a method for modelling the behavior of wild boars who have been in contact with scare-off measures. 

## Research Question
Once a scare-off measure has been set into action,  it needs to be examined weather or not it has an effect. Therefore, the following research question was formulated:

How can the behavior of the boars who had been in contact with a Schreck be modeled?

The hypothesis is that their behavior can be modeled by comparing the average time they spent in a certain field before the scare-off measure called "Schreck" was put into action, during and after. A second approach of calculating the distance of the boar to the Schreck will also be shown in this project.

##Data
In order to achieve this project's goal long-term data for movement trajectories is necessary (at least 6 weeks). The data has to be of different times of day and of several individuals in a similar location. Furthermore, mapdata is needed.

##Analytical concepts
The analytical concepts used in this project are as follows.
EDA was used for plotting the data in order to get an idea of what the data looks like and finding patterns like which individual is affected by which Schreck.
Distances to Scare-Off-Location over time were calculated using the ST_Distance() function, which returns the shortest distance that separates two geometries.
Trajectories with Moving Window Method were used to remove static points.
Spatial and time overlaps between the tracked animals were plotted.
A binary approach was used to find returning patterns by building a "In the Field / not in the Field" vs. distance to Schreck graph.

##R concepts
The modeling was done using the following concepts and packages:

Spatial objects were created with the r-package "sf"

Raster data and background maps were plotted and visualized with these r-packages: "plotly", "ggplot2"

For the reshaping and transforming of data the r-package "tidyverse" were used.

##Risk analysis

The scope is considered a risk because of the amount of behaviors that could potentially be analysed. It is important to only analyse whats needed in order to answer the research question of this project.
The Interpretation of behaviors might be vague or false because an emerging pattern is only correlated but not causal.
Technical difficulties could also pose a risk, e.g. when handling too much data, choosing irrelevant thresholds or interpretation issues.
Possibly, the different measures don't show the same effects. It might be necessary to distinguish between measures in order to draw inferences.

#Methods
##Data processing
The data was loaded and conferted into the coordination system crs = 2056.To find out, which boars were affected by which Schreck, the datasets were both transformed into the same coordinate system using st_transform. They were subsequently plotted on top of each other to visualize the spatial overlap.
```{r temporal overlap, eval=FALSE, include=FALSE}
#load data and put into readable format
sampling_periods <- wildschwein_BE %>%
  group_by(TierID, TierName, CollarID) %>%
  summarise(
    min = min(DatetimeUTC),
    max = max(DatetimeUTC)
  )


wildschwein_overlap_temp <- wildschwein_overlap_temp %>%
  left_join(sampling_periods, by = c("TierID", "TierName", "CollarID"))


wildschwein_overlap_temp %>%
mutate(TierCollar = paste(TierName, CollarID)) %>%
  ggplot(aes(xmin = min, xmax = max, y = TierCollar)) +
  geom_errorbarh() +
  facet_grid(Groups~., scales = "free_y", space = "free_y")

```

```{r spatial overlap, include=FALSE}
#convert into same coordinate system

wildschwein_sf <- wildschwein_BE %>%
  st_as_sf(coords = c("E", "N"), crs = 2056) %>%
  mutate(tiercollar = paste(TierID, TierName, CollarID)) 

wildschwein_convex_hull <- wildschwein_sf %>%
  group_by(TierID, TierName, CollarID) %>%
  summarise() %>%
  st_convex_hull()


wildschwein_convex_hull %>%
  mutate(tiercollar = paste(TierID, TierName, CollarID)) %>%
  ggplot(aes(fill = factor(TierID))) + geom_sf(alpha = 0.1) +
  coord_sf(datum = 2056) +
  facet_wrap(~tiercollar) +
  theme(legend.position = "none")


st_overlaps(wildschwein_convex_hull, sparse = FALSE)[1:5, 1:5]
```

```{r EDA}
#looking at all data points

#schreck_locations needs to be transformed into the same coordinate system
schreck_locations_sf <- schreck_locations %>%
  st_as_sf(coords = c("lon", "lat"), crs = 4326) %>%
  st_transform(2056)

#plot wildschweins and schrecks together to see their spatial overlap
ggplot() +
  geom_sf(data=wildschwein_sf,aes(fill=TierID)) +
  geom_sf(data=schreck_locations_sf, aes(color=region)) +
  coord_sf(datum=2056)
```
As a result, it was found that the animals were only tracked around the Schreck in the region of Fanel. As a consequence, all other Schreck data points were removed and the spatial overlap replotted.

```{r filter all but region Fanel}
#only Fanel
schreck_locations_sf_fanel <- schreck_locations_sf %>%
  filter(region=="fanel")

ggplot() +
  geom_sf(data=wildschwein_sf,aes(fill=TierID)) +
  geom_sf(data=schreck_locations_sf_fanel, aes(color=region)) +
  coord_sf(datum=2056)
```

In order to combine the data about the Schreck locations and their corresponding agenda, or sounding time, they were joined by their matching column "id" with an inner join.
Following this join, the agenda of all the "Schreck time" was visualized using an errorbar plot.

```{r join schreck agendas fanel}
agenda_fanel <- inner_join(schreck_locations_sf_fanel, schreck_agenda, by="id")

#show when the schrecks in fanel were used
ggplot(agenda_fanel, aes(xmin = datum_on, xmax = datum_off, y=id )) +
  geom_errorbarh()
```

##simplyfing the dataset and selecting the boars and Schrecks which will be examined further
In order to see which animals were tracked during the active period of the "Schreck", the boar data was filtered by the dates in which the Schreck were active.
For the tracked boars, a distance between their coordinates and the Schreck coordinate was calculated using st_distance().

To single out the boars which could have been affected by the Schreck, all boars wo never came into the radius of 2 km of the Schreck were removed. The remaining distances were plotted against the DatetimeUTC column.

The plot for Schreck WSS_2014_04 looks as follows:
```{r distance to Schreck 1}
#1 Schreck filter
schreck1 <- agenda_fanel[1,]

#filter for Schreck period

wildschwein_schreck1 <- filter(wildschwein_sf,DatetimeUTC>schreck1$datum_on,DatetimeUTC<schreck1$datum_off)

#add st_distance as a column
wildschwein_schreck1$distance <- as.numeric(st_distance(wildschwein_schreck1,schreck1)[,1])

#ggplot

ggplot(wildschwein_schreck1, aes(DatetimeUTC,distance, color=TierName)) + geom_point() + labs(title="Distance of the affected boars to Schreck WSS_2014_04")
```
Since we don't know, how close you would need to be to hear the Schreck, all of the five boars Caroline, Isabelle, Nicole, Sabine and Ueli could potentially have been affected.

The same procedure was done for Schreck WSS_2014_05.

```{r distance to Schreck 2}
#filter for schreck and running period
schreck2 <- agenda_fanel[2,]

wildschwein_schreck2 <- filter(wildschwein_sf,DatetimeUTC>schreck2$datum_on,DatetimeUTC<schreck2$datum_off)

#add distance
wildschwein_schreck2$distance <- as.numeric(st_distance(wildschwein_schreck2,schreck2)[,1])
#ggplot

ggplot(wildschwein_schreck2, aes(DatetimeUTC,distance, color=TierName)) + geom_point() + labs(title="Distance of the affected boars to Schreck WSS_2014_05")
```

The same five boars could have been affected. This comes at no surprise, since the two Schreck are essentially the same Schreck with the only difference that on the later the sound mode was switched from "normal" to " aggressive".

However, there's not sufficient data of those boars movement before and after the Schreck-period.

Schreck number 3 can be disregarded, since no animal was close to it while it was active. Only one animal was close to Schreck number 4 which will also be disregarded since there are no animals to compare.

The plot for Schreck WSS_2015_01 looks as follows:

```{r distance to Schreck 5}
#filter
schreck5 <- agenda_fanel[5,]

wildschwein_schreck5 <- filter(wildschwein_sf,DatetimeUTC>schreck5$datum_on,DatetimeUTC<schreck5$datum_off)

#add distance
wildschwein_schreck5$distance <- as.numeric(st_distance(wildschwein_schreck5,schreck5)[,1])

#ggplot

ggplot(wildschwein_schreck5, aes(DatetimeUTC,distance, color=TierName)) + geom_point() + labs(title="Distance of the affected boars to Schreck WSS_2015_01")
```
Many boars could have been affected by Schreck 5, whereas only a few seem to have been close enough. The animals that were tracked further away will be filtered out.
The plot for Schreck WSS_2015_01 but in aggressive mode looks as follows:

```{r distance to Schreck}
#filter
schreck6 <- agenda_fanel[6,]

wildschwein_sf$distance <- as.numeric(st_distance(wildschwein_sf,schreck6)[,1])

affected_distance6 <- wildschwein_sf %>%
  filter(TierName == c("Caroline","Olga","Sabine"), DatetimeUTC > "2015-05-01 21:01:14",DatetimeUTC < "2015-08-12 21:01:14")

#ggplot
ggplot(affected_distance6, aes(DatetimeUTC,distance, color=TierName)) + geom_point() + labs(title="Distance of the affected boars to Schreck WSS_2015_01")
```

Olga, Sabine and Caroline will be further examined, because they were in the area as well as tracked before and after.  

Schreck 7, 8 and 9 will be disregarded because only one boar fulfills requirements of being tracked in the area before, during and after Schreck-time respectively. This would again pose the problem of lacking comparability.

```{r distance to Schreck 10}
#filter
schreck10 <- agenda_fanel[10,]

wildschwein_schreck10 <- filter(wildschwein_sf,DatetimeUTC>schreck10$datum_on,DatetimeUTC<schreck10$datum_off)

#add distance
wildschwein_schreck10$distance <- as.numeric(st_distance(wildschwein_schreck10,schreck10)[,1])

#ggplot

ggplot(wildschwein_schreck10, aes(DatetimeUTC,distance, color=TierName)) + geom_point() + labs(title="Distance of the affected boars to Schreck WSS_2015_04")
```
Schreck WSS_2015_04 was close enough for many.Ruth, Sabine, Olga and Caroline were also tracked before and after.

```{r distance to Schreck 11}
# filter
schreck11 <- agenda_fanel[11,]

wildschwein_schreck11 <- filter(wildschwein_sf,DatetimeUTC>schreck11$datum_on,DatetimeUTC<schreck11$datum_off)

#add distance
wildschwein_schreck11$distance <- as.numeric(st_distance(wildschwein_schreck11,schreck11)[,1])

#ggplot

ggplot(wildschwein_schreck11, aes(DatetimeUTC,distance, color=TierName)) + geom_point() + labs(title="Distance of the affected boars to Schreck WSS_2016_01")
```
Many boars were affected by Schreck WSS_2016_01.Miriam, Frida, Caroline and Ueli were also tracked before and after.

This leads to the selection of boars and Schrecks which will be analyzed further as follows:
Schreck 1 and 2 and 4 will de disregarded because there is no data of boars that were tracked in this region before, during and after the Schreck, so there would be nothing to compare the Schrecks effect with.

Schreck 3 will be disregarded because no boar was tracked in its vicinity. 

Schreck 7, 8 and 9 will be disregarded because only one boar fulfills requirements of being tracked in the area before, during and after Schreck-time respectively. This would again pose the problem of lacking comparability.

Hence only Schreck 5, 6, 10, and 11 could be further analyzed.

For Schreck 5 and 6, respectively, the boars Olga, Sabine and Caroline could be further examined, because they were in the area as well as tracked before and after. 
The same applies for Schreck 10 with Ruth, Sabine, Olga and Caroline.

For Schreck 11 it could be Miriam, Frida, Caroline and Ueli.


# Results
##Distance to Schreck approach
Using the approach of calculating the distance of the boar to the Schreck provides the following results.

Sabine and Isabelle seem to have come the closest to Schreck WSS_2014_04, so there distance to the Schreck during its running time was plotted. 
```{r distance to Schreck 1}

wildschwein_sf$distance_Schreck1 <- as.numeric(st_distance(wildschwein_sf,schreck1)[,1])

filter
affected_distance <- wildschwein_sf %>%
  filter(TierName == c("Sabine","Isabelle"),DatetimeUTC > "2014-04-01 21:01:14", DatetimeUTC < "2014-12-28 21:01:14")

#ggplot
ggplot(affected_distance, aes(DatetimeUTC,distance_Schreck1, color=TierName)) + geom_point() + labs(title="Distance of the affected boars to Schreck WSS_2014_04")
```
Sabine and Isabelle don't seem to be impressed by the Schreck. However they only just came across the Schreck for 2 and 4 days accordingly before the Schreck stopped.

```{r distance to Schreck}

#add distance
wildschwein_sf$distance_Schreck5 <- as.numeric(st_distance(wildschwein_sf,schreck5)[,1])

#filter
affected_distance5 <- wildschwein_sf %>%
  filter(TierName == c("Caroline","Claude","Olga","Sabine"), DatetimeUTC > "2015-05-20 21:01:14",DatetimeUTC < "2015-06-12 21:01:14")

#ggplot
ggplot(affected_distance5, aes(DatetimeUTC,distance_Schreck5, color=TierName)) + geom_point() + labs(title="Distance of the affected boars to Schreck WSS_2015_01")
```
Schreck 5 was running from 2015-05-20 to 2015-06-12. It looks as if in the beginning the boars kept a distance of half a kilometer, but came back after about a month.

```{r Caroline and Schreck 5}
distance5_longerThanSchrecking <- wildschwein_sf %>%
  filter(TierName == "Caroline", DatetimeUTC > "2015-04-01", DatetimeUTC < "2015-04-05")

ggplot(distance5_longerThanSchrecking,aes(DatetimeUTC,distance_Schreck5)) + geom_point()
```
Caroline's moving pattern shows her staying in one place during the days (mostly between 6-9 am to around 6pm). That's most likely when she's sleeping. Movements are only at night, which was to be expected of a nocturnal animal. Later, we'll explore which kind of field this Schreck 5 is in.

There seems to be some short time effect on the boars especially of Schreck 5. It looks like the boars moved away a bit in the beginning. However, there is no way of showing that this effect was due to the Schreck and not simply a coincidence using this approach.

##In the field vs. out of the field before, during and after approach
How much time does a boar spend in the field before the Schreck (in %), during and after? 
```{r in the field vs not in the field during SChreck time}
#Im Feld drin = TRUE --> alle in inter_sel_5


disjoint_195andSchreck5 <- st_disjoint(forest_bohnen195,distance5_Caroline_Schrecktime)
class(intersection_195andSchreck5)

disjoint_caroline_5 <- distance5_Caroline_Schrecktime[disjoint_195andSchreck5[[1]],]


#nun die ausserhalb mit 0 und die innerhalb mit 1 ergänzen
disjoint_caroline_5$inField <- 0
inter_sel_5$inField <- 1
#append the two data sets again with their new columns
Caroline_Schreck5_withField <- bind_rows(disjoint_caroline_5,inter_sel_5)

  


#47 from 2207 Data points are in the field
print(47/2207*100)
# during Schreck time she spends 2 % of her time in the field.

# now the same for before and after

#Idea: also display graphically the distribution of "In" and "Not In" Before, during and after
```

#Discussion
Using the distance of boar to Schreck approach has the disadvantage that there is no way of showing that an effect was due to the Schreck and not simply a coincidence. This approach is good for getting a first idea of the boars movement and to select the Schrecks and boars with which to continue in further analysis. It shows which boars were in the vicinity of a Schreck and could therefore possibly have been affected by it.
